name: Build Android APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Wyczyszczona lista - tylko niezbędne narzędzia do kompilacji
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip build-essential git python3 python3-dev \
            openjdk-17-jdk unzip zip autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 \
            cmake libffi-dev libssl-dev libunwind-dev

      - name: Install Buildozer & Cython
        run: |
          pip3 install --upgrade pip
          pip3 install buildozer cython==0.29.33

      - name: Configure Buildozer
        run: |
          # Jeśli nie ma pliku spec, stwórz go
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi
          
          # --- Aplikowanie poprawek do pliku spec ---
          
          # Biblioteki (Kivy, Requests, Pyjnius)
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy==2.3.0,requests,android,pyjnius/' buildozer.spec
          
          # Uprawnienia (SMS, Kontakty)
          sed -i 's/#android.permissions = INTERNET/android.permissions = INTERNET,READ_SMS,READ_CONTACTS,READ_EXTERNAL_STORAGE/' buildozer.spec
          
          # API i Architektura (J3 + S20)
          sed -i 's/android.api = 27/android.api = 33/' buildozer.spec
          sed -i 's/android.minapi = 21/android.minapi = 21/' buildozer.spec
          sed -i 's/#android.archs = armeabi-v7a/android.archs = armeabi-v7a, arm64-v8a/' buildozer.spec
          
          # Fix: Cleartext HTTP (Naprawa błędu sieci)
          sed -i 's/#android.manifest.application_attributes =/android.manifest.application_attributes = android:usesCleartextTraffic="true"/' buildozer.spec
          
          # Fix: Wymuszenie stabilnego NDK
          sed -i 's/# android.ndk = 23b/android.ndk = 25b/' buildozer.spec
          
          # Fix: Automatyczna akceptacja licencji (Zamiast "yes |")
          sed -i 's/# android.accept_sdk_license = False/android.accept_sdk_license = True/' buildozer.spec

      - name: Build with Buildozer
        run: |
          # Teraz komenda jest czysta - bez "yes |"
          buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: DrPhone-APK
          path: bin/*.apk
